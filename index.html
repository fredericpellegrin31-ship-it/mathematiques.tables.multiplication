<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bataille des Multiplications CE1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .hud { position: absolute; background: rgba(0,0,0,0.6); color: white; padding: 15px; border-radius: 10px; pointer-events: auto; }
        #question-box { top: 20px; left: 50%; transform: translateX(-50%); text-align: center; min-width: 250px; border: 3px solid #fbbf24; }
        #stats-box { top: 20px; left: 20px; }
        #controls-hint { bottom: 20px; left: 20px; font-size: 0.9rem; }
        #game-over { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; color: #1e293b; padding: 40px; border-radius: 20px; 
            text-align: center; display: none; pointer-events: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="question-box" class="hud">
            <p class="text-lg uppercase font-bold text-amber-400">Trouve le r√©sultat de :</p>
            <p id="current-multiplication" class="text-5xl font-black">-- x --</p>
        </div>

        <div id="stats-box" class="hud">
            <p class="font-bold">‚è≥ Temps : <span id="timer">02:00</span></p>
            <p class="font-bold">üèÜ Score : <span id="score">0</span></p>
        </div>

        <div id="controls-hint" class="hud">
            üñ±Ô∏è <b>Souris :</b> Viser & Tirer<br>
            ‚å®Ô∏è <b>Z,Q,S,D :</b> D√©placer le navire
        </div>
    </div>

    <div id="game-over">
        <h2 class="text-4xl font-bold mb-2">Fin de la mission !</h2>
        <p class="text-xl mb-6">Tu as coul√© <span id="final-score">0</span> navires ennemis.</p>
        <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-full font-bold text-xl transition">Recommencer</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        let scene, camera, renderer, clock;
        let playerShip, score = 0, timeLeft = 120;
        let gameActive = true;
        let currentTargetValue = 0;
        
        const enemies = [];
        const cannonBalls = [];
        const keys = {};

        // Simulation des textures pour les √©tiquettes de score
        function createTextCanvas(text) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 128;
            canvas.height = 128;
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 128, 128);
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 80px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, 64, 64);
            return canvas;
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 20, 150);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            clock = new THREE.Clock();

            // Lumi√®res
            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(50, 50, 20);
            scene.add(sun);

            // Mer
            const seaGeo = new THREE.PlaneGeometry(1000, 1000);
            const seaMat = new THREE.MeshPhongMaterial({ color: 0x0ea5e9, shininess: 80 });
            const sea = new THREE.Mesh(seaGeo, seaMat);
            sea.rotation.x = -Math.PI / 2;
            scene.add(sea);

            // Joueur (simule ship-medium.obj)
            const playerGroup = new THREE.Group();
            const hull = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 4), new THREE.MeshPhongMaterial({color: 0x4ade80}));
            hull.position.y = 0.5;
            playerGroup.add(hull);
            playerShip = playerGroup;
            scene.add(playerShip);

            // Placement initial de la cam√©ra
            camera.position.set(0, 10, 15);
            playerShip.add(camera);
            camera.position.set(0, 8, 12);
            camera.lookAt(new THREE.Vector3(0, 0, -10));

            // Environnement (Rochers d√©coratifs)
            spawnEnvironment();

            // Lancer la premi√®re question
            generateQuestion();
            spawnEnemies();

            // Events
            window.addEventListener('keydown', (e) => keys[e.code] = true);
            window.addEventListener('keyup', (e) => keys[e.code] = false);
            window.addEventListener('mousedown', fireCannon);
            window.addEventListener('resize', onWindowResize);

            // Timer loop
            setInterval(() => {
                if (gameActive) {
                    timeLeft--;
                    updateUI();
                    if (timeLeft <= 0) endGame();
                }
            }, 1000);

            animate();
        }

        function spawnEnvironment() {
            // Utilise les formes pour simuler rocks-a, rocks-sand-a, etc.
            for (let i = 0; i < 40; i++) {
                const rock = new THREE.Mesh(
                    new THREE.DodecahedronGeometry(2 + Math.random() * 3),
                    new THREE.MeshPhongMaterial({ color: Math.random() > 0.5 ? 0x888888 : 0xd2b48c })
                );
                rock.position.set((Math.random() - 0.5) * 300, -1, (Math.random() - 0.5) * 300);
                scene.add(rock);
            }
        }

        function generateQuestion() {
            const a = Math.floor(Math.random() * 6) + 2; // de 2 √† 7
            const b = Math.floor(Math.random() * 9) + 1; // de 1 √† 9
            currentTargetValue = a * b;
            document.getElementById('current-multiplication').innerText = `${a} x ${b}`;
        }

        function spawnEnemies() {
            // Nettoyer anciens ennemis si besoin
            enemies.forEach(e => scene.remove(e));
            enemies.length = 0;

            const possibleAnswers = [currentTargetValue];
            while (possibleAnswers.length < 4) {
                let fake = (Math.floor(Math.random() * 9) + 1) * (Math.floor(Math.random() * 9) + 1);
                if (!possibleAnswers.includes(fake)) possibleAnswers.push(fake);
            }
            // M√©langer
            possibleAnswers.sort(() => Math.random() - 0.5);

            possibleAnswers.forEach((val, index) => {
                const enemyGroup = new THREE.Group();
                
                // Le bateau (simule ship-pirate-medium.obj)
                const boat = new THREE.Mesh(new THREE.BoxGeometry(3, 1.5, 6), new THREE.MeshPhongMaterial({color: 0xef4444}));
                boat.position.y = 0.75;
                enemyGroup.add(boat);

                // √âtiquette de score (Sprite)
                const canvas = createTextCanvas(val);
                const texture = new THREE.CanvasTexture(canvas);
                const spriteMat = new THREE.SpriteMaterial({ map: texture });
                const sprite = new THREE.Sprite(spriteMat);
                sprite.position.y = 5;
                sprite.scale.set(4, 4, 1);
                enemyGroup.add(sprite);

                // Position al√©atoire autour du joueur
                const angle = (index / 4) * Math.PI * 2;
                const dist = 40 + Math.random() * 20;
                enemyGroup.position.set(
                    playerShip.position.x + Math.cos(angle) * dist,
                    0,
                    playerShip.position.z + Math.sin(angle) * dist
                );

                enemyGroup.userData = { value: val };
                scene.add(enemyGroup);
                enemies.push(enemyGroup);
            });
        }

        function fireCannon() {
            if (!gameActive) return;

            // Simule cannon-ball.obj
            const ball = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshPhongMaterial({color: 0x333333}));
            ball.position.copy(playerShip.position);
            ball.position.y = 1;

            // Direction bas√©e sur l'orientation du bateau
            const dir = new THREE.Vector3(0, 0, -1);
            dir.applyQuaternion(playerShip.quaternion);
            
            ball.userData.velocity = dir.multiplyScalar(1.5);
            ball.userData.life = 100;

            scene.add(ball);
            cannonBalls.push(ball);
        }

        function updateUI() {
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            document.getElementById('timer').innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
            document.getElementById('score').innerText = score;
        }

        function animate() {
            requestAnimationFrame(animate);
            if (!gameActive) {
                renderer.render(scene, camera);
                return;
            }

            const delta = clock.getDelta();

            // Mouvement Joueur
            if (keys['KeyW'] || keys['ArrowUp']) {
                playerShip.translateZ(-0.2);
            }
            if (keys['KeyS'] || keys['ArrowDown']) {
                playerShip.translateZ(0.1);
            }
            if (keys['KeyA'] || keys['ArrowLeft']) {
                playerShip.rotation.y += 0.03;
            }
            if (keys['KeyD'] || keys['ArrowRight']) {
                playerShip.rotation.y -= 0.03;
            }

            // Mouvement Boulets
            for (let i = cannonBalls.length - 1; i >= 0; i--) {
                const b = cannonBalls[i];
                b.position.add(b.userData.velocity);
                b.userData.life--;

                if (b.userData.life <= 0) {
                    scene.remove(b);
                    cannonBalls.splice(i, 1);
                    continue;
                }

                // Collisions
                enemies.forEach((enemy, eIdx) => {
                    if (b.position.distanceTo(enemy.position) < 4) {
                        if (enemy.userData.value === currentTargetValue) {
                            score++;
                            generateQuestion();
                            spawnEnemies(); // Reg√©n√©rer de nouvelles cibles
                        } else {
                            // Mauvaise r√©ponse : p√©nalit√© temps ?
                            timeLeft = Math.max(0, timeLeft - 5);
                        }
                        scene.remove(b);
                        cannonBalls.splice(i, 1);
                    }
                });
            }

            // Balancement des bateaux
            const time = Date.now() * 0.001;
            playerShip.rotation.z = Math.sin(time) * 0.02;
            enemies.forEach(e => {
                e.rotation.z = Math.cos(time + e.position.x) * 0.03;
            });

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function endGame() {
            gameActive = false;
            document.getElementById('game-over').style.display = 'block';
            document.getElementById('final-score').innerText = score;
        }

        window.onload = init;
    </script>
</body>
</html>
